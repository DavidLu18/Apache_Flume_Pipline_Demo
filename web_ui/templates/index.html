{% extends "base.html" %}

{% block title %}Live Thread - Reddit F1{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar - Filters -->
    <div class="col-md-3">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="fas fa-filter"></i> Bộ Lọc
                </h5>
            </div>
            <div class="card-body">
                <!-- Flair Filter -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Flair</label>
                    <select class="form-select" id="flairFilter">
                        <option value="">Tất cả</option>
                    </select>
                </div>
                
                <!-- Auto Refresh -->
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                    <label class="form-check-label" for="autoRefresh">
                        Auto-refresh (30s)
                    </label>
                </div>
                
                <hr>
                
                <button class="btn btn-danger w-100" onclick="loadPosts()">
                    <i class="fas fa-sync-alt"></i> Làm mới
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Content - Posts -->
    <div class="col-md-9">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h4 class="mb-0">
                    <i class="fas fa-fire"></i> Live Thread - r/formula1
                </h4>
            </div>
            <div class="card-body">
                <div id="postsContainer">
                    <div class="text-center py-5">
                        <div class="spinner-border text-danger" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                        <p class="mt-3">Đang tải posts...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let autoRefreshInterval;
let currentFlair = '';

// Load posts khi trang load
document.addEventListener('DOMContentLoaded', function() {
    loadFlairs();
    loadPosts();
    setupAutoRefresh();
});

// Load danh sách flairs
async function loadFlairs() {
    try {
        const response = await fetch('/api/flairs');
        const result = await response.json();
        
        if (result.success) {
            const select = document.getElementById('flairFilter');
            result.data.forEach(flair => {
                const option = document.createElement('option');
                option.value = flair;
                option.textContent = flair;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading flairs:', error);
    }
}

// Load posts
async function loadPosts() {
    const container = document.getElementById('postsContainer');
    
    try {
        let url = '/api/posts?limit=20';
        if (currentFlair) {
            url += `&flair=${encodeURIComponent(currentFlair)}`;
        }
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
            container.innerHTML = result.data.map(post => renderPost(post)).join('');
        } else {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Chưa có posts nào.
                </div>
            `;
        }
    } catch (error) {
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> Lỗi khi tải posts: ${error.message}
            </div>
        `;
    }
}

// Render một post
function renderPost(post) {
    const date = new Date(post.created_utc);
    const timeAgo = getTimeAgo(date);
    
    return `
        <div class="post-card mb-4">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h5 class="post-title">
                        <a href="/post/${post.id}">${escapeHtml(post.title)}</a>
                    </h5>
                    <div class="post-meta">
                        ${post.flair ? `<span class="badge bg-primary">${escapeHtml(post.flair)}</span>` : ''}
                        <span class="text-muted ms-2">
                            <i class="far fa-clock"></i> ${timeAgo}
                        </span>
                    </div>
                    ${post.content ? `<p class="post-content mt-2">${escapeHtml(post.content.substring(0, 200))}${post.content.length > 200 ? '...' : ''}</p>` : ''}
                </div>
                <div class="post-score ms-3 text-center">
                    <div class="score-value">${post.score}</div>
                    <small class="text-muted">điểm</small>
                </div>
            </div>
            <div class="post-actions mt-3">
                <button class="btn btn-sm btn-outline-primary" onclick="viewPost('${post.id}')">
                    <i class="fas fa-comments"></i> Xem Comments
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="subscribeToPost('${post.id}')">
                    <i class="fas fa-bell"></i> Theo dõi
                </button>
            </div>
        </div>
    `;
}

// View post detail
function viewPost(postId) {
    window.location.href = `/post/${postId}`;
}

// Subscribe to post
async function subscribeToPost(postId) {
    try {
        const response = await fetch('/api/subscriptions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                post_id: postId,
                user_id: 'demo_user'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('✓ Đã theo dõi post này!');
        } else {
            alert('✗ Lỗi: ' + result.error);
        }
    } catch (error) {
        alert('✗ Lỗi khi theo dõi: ' + error.message);
    }
}

// Setup auto refresh
function setupAutoRefresh() {
    const checkbox = document.getElementById('autoRefresh');
    
    if (checkbox.checked) {
        autoRefreshInterval = setInterval(loadPosts, 30000); // 30 seconds
    }
    
    checkbox.addEventListener('change', function() {
        if (this.checked) {
            autoRefreshInterval = setInterval(loadPosts, 30000);
        } else {
            clearInterval(autoRefreshInterval);
        }
    });
}

// Flair filter change
document.getElementById('flairFilter').addEventListener('change', function() {
    currentFlair = this.value;
    loadPosts();
});

// Helper functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    
    if (diffMins < 1) return 'Vừa xong';
    if (diffMins < 60) return `${diffMins} phút trước`;
    
    const diffHours = Math.floor(diffMins / 60);
    if (diffHours < 24) return `${diffHours} giờ trước`;
    
    const diffDays = Math.floor(diffHours / 24);
    return `${diffDays} ngày trước`;
}
</script>
{% endblock %}
